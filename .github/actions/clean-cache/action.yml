name: "Clean Cache"
description: "Clean GitHub Actions cache for a PR branch"

inputs:
  gh-token:
    description: "GitHub token for API access"
    required: true
  gh-repo:
    description: "GitHub repository in owner/repo format"
    required: true
  branch:
    description: "Branch reference to clean cache for"
    required: true

runs:
  using: "composite"
  steps:
    - name: Clean cache
      run: |
        echo "Fetching list of cache key"
        cacheKeysForPR=$(gh cache list --ref "$BRANCH" --limit 100 --json id --jq '.[].id')

        ## Setting this to not fail the workflow while deleting cache keys.
        set +e
        echo "Deleting caches..."
        for cacheKey in $cacheKeysForPR
        do
            gh cache delete "$cacheKey"
        done
        echo "Done"
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh-token }}
        GH_REPO: ${{ inputs.gh-repo }}
        BRANCH: ${{ inputs.branch }}
